一、产品整体概述
1.1 产品定位

一款围绕「每日行动 + 目标养成 + 健康数据自动同步」的健康管理 App。

核心卖点：

自动同步

iOS：从 Apple Health 读取：步数、活动能量、心率、HRV、睡眠、体重等

Android：通过 Health Connect 读取同类数据

轻计划 + 日历 + 周回顾

今日卡片（计划进度、体重、热量预算）

健身日历（周/月统计）

每周回顾卡片

目标 & 宠物养成

内置「推荐目标」模板（吃早餐、多喝水、睡够 8 小时、每周运动…）

完成目标获得经验值，提升小宠物等级

AI 小伙伴（可后端接 LLM）：

聊天、饮食分析、简单健康建议（非医疗）

二、信息架构 & 页面

底部 4 个 Tab：

今天

行动（日历）

目标

设置

再加几个二级页面：

创建/编辑目标（弹层或单独页）

当日目标回顾

每周回顾

数据源设置（Apple / Health Connect）

个人信息/专属计划设置

AI 聊天页

三、详细功能需求（PRD）
3.1 今天（Dashboard）
3.1.1 顶部：每日行动 / 计划概览卡

展示内容：

当前计划第 N 天 & 总天数

初始体重 / 最新体重 / 目标体重

圆弧仪表盘：

中间显示最新体重

下方显示 BMI 值

计划开始日期 / 结束日期

当前计划状态：进行中 / 已结束 / 未设置

交互：

当前无计划时，显示「开始新计划」按钮

点击进入「创建/编辑减重计划」：

初始体重（默认读取当前体重）

目标体重

计划时长（如 30 天、60 天）

自动根据基础代谢 & 活动水平预估每天热量目标（仅文案展示）

3.1.2 今日卡路里卡片

显示公式：

还能吃（千卡） = 今日消耗 - 今日已吃 - 预设缺口

「消耗」：从健康数据同步得来（基础代谢 + 活动消耗），简单版可以只用活动消耗或只用步数转化

「饮食」：用户记录的热量合计

「缺口」：用户设置的每日目标热量赤字（可选）

展示内容：

大数字：今日还能吃千卡

下方小字：消耗 XXX - 饮食 YYY - 缺口 ZZZ

下方四个入口：早餐 / 午餐 / 晚餐 / 加餐（每个是一个按钮，点击进入「添加饮食」）

饮食记录简化设计：

MVP 先不做巨大食物库，只做：

用户自己录入食物名称 + 估算 kcal

或者提供若干常见模板（早餐包子/鸡蛋/牛奶等）

后续可接第三方食物库再升级

3.1.3 今日体重卡片

显示今日体重（如有）和与前一次差值

「+」按钮：快速记录体重（弹出底部输入框）

进入体重历史页（折线图）：

时间范围：7/30/90 天

每天一条点

3.2 行动 Tab（健身日历）
3.2.1 周 / 月视图切换

顶部 Segment：周 / 月。

周视图：

日期范围：例如 11月9日 - 11月15日

显示：

连胜状态（连续达标天数 / 中断）

本周：

运动达标天数

总运动分钟

总消耗千卡

下方一行：周日 ~ 周六，每天显示是否有运动（可用圆点/颜色深浅）

月视图：

每天小方块或小圆点，颜色代表活动量（0~3 级）

交互：

点击某一天进入「当天详情」：

显示该天步数、运动分钟、消耗、睡眠等简要信息

可跳转到当天「回顾」页面

3.3 目标 Tab（目标 + 宠物）
3.3.1 宠物头部区域

显示宠物名字（可默认 TATA，可后续自定义）

展示「Ob陪伴天数」如 TATA 3 天

经验条：

当前等级 Lv.X

经验值 当前经验/升级所需

点击宠物可打开宠物详情（皮肤、解锁条件、简单动画）

3.3.2 目标看板

内容：

一组目标卡片，每个包含：

目标名称（坚持吃早餐、每周至少运动一次、睡眠 ≥ 8h 等）

完成进度条：今天完成次数 / 今日目标次数 或 本周完成天数 / 目标天数

右侧打勾按钮：用于当日打卡（一次或多次）

目标类型：

每日型（如：喝 8 杯水、吃早餐、睡前不玩手机）

每周型（如：每周至少运动 2 次）

时长型（如：睡眠时长 ≥ 8 小时；运动时间 ≥ 30 分钟）

「回顾」入口：

右上角按钮进入「回顾」页，按日期查看当天目标完成情况。

3.3.3 创建新目标（Bottom Sheet）

点击底部浮动「+」：

弹出「创建新目标」面板：

推荐 / 改善睡眠 / 生活习惯 等分类 Tab

推荐列表：

坚持吃早餐

喝八杯水

锻炼时长达标

睡前不玩手机 …

顶部有“创建自定义目标”入口

点击某个模板 / 自定义后进入「目标编辑页」：

图标（选择或默认）

目标名称（可编辑）

目标重复周期：每日 / 每周 / 自定义

频率：

每日：每天 N 次

每周：每周 N 天

提醒开关 + 提醒时间（支持一天多次可后续扩展）

保存后：写入目标表；安排本地通知

3.3.4 回顾页（目标完成列表）

顶部日期横向滚动（类似 9、10、11、12 …）

当前日期下方显示当日所有目标：

每个目标的完成次数 / 目标次数

完成的标记勾选 / 灰色

支持左右滑一天，查看历史

3.4 设置 Tab
3.4.1 活力指数

顶部类似一个「小月历热力图」：

X 轴：月份（8、9、10、11…）

每个格子代表某一天的「活动量等级」（基于步数或消耗热量）

仅展示，不要复杂交互

3.4.2 设置项列表

关于你（进入个人信息 / 专属计划）

会员 / 专业版（预留）

数据来源

iOS：Apple Health

Android：Google Health Connect

语言

通知

单位（kg / lb，cm / inch）

好友（预留）

云同步（预留）

更新日志

常见问题

问题反馈

隐私协议

用户协议

3.5 个人信息 / 专属计划

入口：设置 -> 关于你 / 或首次启动引导弹窗。

性别

身高

当前体重

出生日期

活动水平（久坐 / 轻度 / 中度 / 高度）

用于：

估算基础代谢

生成初始体重目标建议 / 热量缺口建议

在「每周回顾」中个性化一些称号文案

3.6 每周回顾

展示周称号（如“压根没动”“还不错”“能量满满”等）

周日期范围：11月2日 - 11月8日

展示指标：

平均睡眠时长

平均 HRV（如有）

总步数

饮水天数

总消耗千卡

锻炼总时长

底部“分享”按钮：生成分享卡片图片（后续可调 Flutter 画布导出）

3.7 AI 聊天（TATA）

一个独立页面或入口（例如目标 Tab 顶部小按钮 / 设置里的「健康助手」）：

对话气泡 UI

输入框 + 发送按钮

快捷按钮（如“今日饮食分析”“帮我定一个本周目标”）

上方显示提示：“内容由 AI 生成，仅供参考，不构成医疗建议”

数据交互：

前端将用户对话 + 当日汇总的关键指标（热量、睡眠、步数等）发送给后端 AI 服务

将返回文本显示在气泡里

四、User Stories（按模块）
Epic 1：数据源 & 专属计划

US-1.1 首次启动，我希望填写性别、身高、体重、活动水平，以便 App 给我更合适的目标建议。

US-1.2 作为 Apple Watch / Android 表用户，我希望在「数据来源」中一键连接 Apple Health / Health Connect，让运动步数和睡眠自动导入，而不是手工记录。

US-1.3 我希望可以随时取消或修改数据权限，以便控制自己的隐私。

Epic 2：今天 & 行动

US-2.1 作为减脂用户，我希望在「今天」看到当前减重计划第几天、初始/最新/目标体重和 BMI。

US-2.2 我希望 App 自动根据我的消耗热量和目标缺口计算「今天还能吃多少千卡」。

US-2.3 我希望快速记录三餐和加餐的大致热量，以便掌握摄入。

US-2.4 我想快速记录体重并看到最近几天的趋势。

US-2.5 在“行动”页，我希望按周/月看到我的运动日历，知道自己有没有坚持。

Epic 3：目标 & 宠物

US-3.1 我希望从推荐列表中一键添加目标（如“坚持吃早餐”“早睡”“每周运动一次”），不用自己想文案。

US-3.2 我希望能创建完全自定义的目标和提醒时间。

US-3.3 每天我完成目标后，想在目标卡上打勾并看到进度条增长。

US-3.4 完成目标后，我的小宠物会获得经验升级，我能看到它成长。

US-3.5 我希望有「回顾」页面，可以按天看到自己哪天完成了哪些目标。

Epic 4：回顾 & 分享

US-4.1 我希望每周能收到一份「每周回顾」，用简单的称号和数据告诉我这一周过得怎么样。

US-4.2 我希望可以一键生成周回顾图片，分享到社交网络。

Epic 5：AI 助手

US-5.1 我希望能和一个“健康小伙伴”聊天，讲讲自己的状态、心情。

US-5.2 我希望它可以结合我今天的饮食和运动，给出一些简单建议（比如多喝水、晚些再吃零食等）。

US-5.3 我希望随时知道这些内容只是参考，不是医生建议。

Epic 6：设置 & 其它

US-6.1 我可以在设置中调整语言、单位、通知。

US-6.2 我可以一键清空本地数据或退出登录（如果未来有云同步）。

US-6.3 我可以在常见问题中快速了解基本功能用法。

五、技术高层架构设计
5.1 技术栈（Flutter）

Flutter 3.x+

状态管理：Riverpod / flutter_riverpod

路由：go_router

持久化：Drift + sqlite3_flutter_libs

健康数据：

health 插件（或 Android 端使用 health 内部的 Health Connect 集成）

iOS：HealthKit（通过插件封装）

通知：flutter_local_notifications

网络：dio（调用 AI Chat / 云同步）

错误 & 崩溃：sentry_flutter

5.2 目录结构
lib/
  app/
    app.dart
    router.dart
    providers.dart
  core/
    theme/
    error/
    utils/
  shared/
    db/
      app_database.dart
    services/
      notification_service.dart
      health_sync_service.dart
      share_card_service.dart
      ai_chat_service.dart
    widgets/
      app_scaffold.dart
      section_card.dart
      empty_state.dart
  features/
    profile/
      presentation/
      application/
      domain/
      data/
    health_source/
      presentation/
      application/
      domain/
      data/
    dashboard/        // 今天
      ...
    activity_calendar/
      ...
    goals/
      ...
    review/
      ...
    settings/
      ...
    gamification/
      ...
    chat_ai/
      ...


分层：

presentation：Widgets + Notifier (Riverpod)

application：UseCase / Facade

domain：实体 + Repository 接口

data：Drift DAO + 第三方插件实现 + Repository 实现

5.3 数据库核心表（Drift 概略）

user_profile：性别、身高、体重、生日、活动水平

plans：当前/历史减重计划

weights：体重记录

meals / meal_items：三餐/加餐记录（可简化为 food_logs）

metrics_daily：每天聚合数据（steps、active_minutes、calories_burned、sleep_hours 等）

goals：目标定义（名称、类型、周期、频率、提醒时间…）

goal_logs：目标完成记录（goal_id + date + progress）

pet_state：宠物等级、当前经验

weekly_summary：每周回顾缓存（可运行时生成再缓存）

settings：主题、语言、单位等

health_sync_state：记录各数据类型最后同步时间戳

六、核心功能实现设计
6.1 Apple / Health Connect 同步

HealthSourceRepository 接口：

abstract class HealthSourceRepository {
  Future<bool> requestPermissions(List<HealthMetricType> types);
  Future<List<ExternalSample>> fetchSamples(DateTime from, DateTime to);
}


ExternalSample：

class ExternalSample {
  final HealthMetricType type;     // steps, heartRate, sleep, weight, ...
  final num value;
  final DateTime start;
  final DateTime end;
  final String source;             // 'apple_health' / 'health_connect'
}


同步 UseCase：

class SyncHealthDataUseCase {
  final HealthSourceRepository _healthRepo;
  final MetricsRepository _metricsRepo;

  SyncHealthDataUseCase(this._healthRepo, this._metricsRepo);

  Future<void> call(DateTime from, DateTime to) async {
    final samples = await _healthRepo.fetchSamples(from, to);
    await _metricsRepo.ingestExternalSamples(samples);
  }
}


ingestExternalSamples：

将 steps、calories、sleep、heartRate 等汇总到 metrics_daily（按日聚合）

体重写进 weights

使用 health_sync_state 记录每种类型的 lastSyncedAt，从而下一次只拉增量

6.2 今日还能吃（热量预算）

假设：

calories_burned_today 从 metrics_daily 获取

calories_intake_today 从 meals 汇总

calorie_deficit_target 从当前计划或设置中读取

计算：

remaining = calories_burned_today - calories_intake_today - calorie_deficit_target;
remaining = max(0, remaining);


前端展示：

若 remaining > 0：显示“还能吃 xxx 千卡”

若 remaining <= 0：显示“今日已超出目标 xxx 千卡”

6.3 目标打卡 & 宠物经验

Goal 实体：

enum GoalPeriod { daily, weekly }

class Goal {
  final int id;
  final String name;
  final GoalPeriod period;
  final int target;        // 每日次数或每周天数
  final TimeOfDay? remindAt;
  final bool enabled;
}


GoalLog：

class GoalLog {
  final int goalId;
  final DateTime date;  // 对于 weekly，可按周起始日折算
  final int progress;   // 当天已完成次数
}


打卡流程：

用户点击目标卡片的打勾按钮

ToggleGoalCompletionUseCase(goalId, date) 被调用：

读取当天的 GoalLog

若未完成则 progress+1；若已经达成且再点击则减 1（允许撤销）

当 progress >= goal.target 时：

触发 GamificationService.awardExp(goal) 给宠物加经验

前端展示轻量动效

宠物经验机制：

class PetState {
  final int level;
  final int exp;
}

class GamificationService {
  static const expPerGoal = 10;

  Future<void> awardExp(Goal goal) async {
    final state = await petRepository.getState();
    final newExp = state.exp + expPerGoal;
    var level = state.level;
    var exp = newExp;

    while (exp >= expNeeded(level)) {
      exp -= expNeeded(level);
      level += 1;
    }

    await petRepository.saveState(level, exp);
  }
}


expNeeded(level) 可以简单用线性/指数函数。

6.4 每周回顾计算

GenerateWeeklySummaryUseCase(weekStart)：

从 metrics_daily 读取这一周的数据；

计算：

平均睡眠、平均 HRV、总步数、总消耗、锻炼总时长；

从 goal_logs / meals 衍生饮水天数、早餐完成率等；

根据规则生成一个「周称号」：

活动量高 + 睡眠充足 → 正向称号

活动量低 + 睡眠不足 → “压根没动”那类

写入/更新 weekly_summary 表；

在 UI 中展示，并通过 share_card_service 生成分享图片。

6.5 本地通知（目标提醒 & 用药）

使用 flutter_local_notifications

notification_service 封装：

scheduleGoalReminder(goalId, timeOfDay)

cancelGoalReminder(goalId)

在保存/删除目标时自动更新通知

Android 要注意在 manifest 声明通知权限，iOS 要在首次启动时请求允许

6.6 AI 聊天

前端：

AiChatNotifier 持有历史消息列表

调用 AiChatService.sendMessage(userMessage, context)：

context 包含今日 metrics & meals & goals 简要信息

后端（你自己实现）：

可以是任何 LLM 服务（OpenAI / 自建等）

Chat 逻辑在后端做 prompt engineering：

明确其角色：可爱健康助手，不能给医疗诊断

参考用户数据给出小建议和鼓励
