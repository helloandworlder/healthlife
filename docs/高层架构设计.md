# HealthLife App é«˜å±‚æ¶æ„è®¾è®¡

## 1. æŠ€æœ¯æ ˆ

| ç±»åˆ« | æŠ€æœ¯é€‰å‹ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|---------|------|------|
| æ¡†æ¶ | Flutter | 3.x+ | è·¨å¹³å°ç§»åŠ¨å¼€å‘æ¡†æ¶ |
| çŠ¶æ€ç®¡ç† | Riverpod + riverpod_annotation | 2.5+ | å“åº”å¼çŠ¶æ€ç®¡ç†ï¼Œæ”¯æŒä»£ç ç”Ÿæˆ |
| è·¯ç”± | go_router + go_router_builder | 14.x | å£°æ˜å¼è·¯ç”±ï¼Œæ”¯æŒç±»å‹å®‰å…¨å’ŒDeep Linking |
| æ•°æ®åº“ | Drift + sqlite3_flutter_libs | 2.x | ç±»å‹å®‰å…¨çš„SQLite ORM |
| å¥åº·æ•°æ® | health | 13.x | Apple HealthKit / Health Connect é›†æˆ |
| æœ¬åœ°é€šçŸ¥ | flutter_local_notifications + timezone | 18.x | è·¨å¹³å°æœ¬åœ°é€šçŸ¥ |
| ç½‘ç»œè¯·æ±‚ | dio | 5.x | HTTPå®¢æˆ·ç«¯ |
| AIèŠå¤© | flutter_ai_toolkit / è‡ªå®šä¹‰å®ç° | - | LLMå¯¹æ¥ |
| é”™è¯¯ç›‘æ§ | sentry_flutter | 8.x | å´©æºƒå’Œæ€§èƒ½ç›‘æ§ |
| ä»£ç ç”Ÿæˆ | build_runner + freezed | - | ä¸å¯å˜æ¨¡å‹å’Œä»£ç ç”Ÿæˆ |
| å›¾è¡¨ | fl_chart | 0.68+ | æŠ˜çº¿å›¾ã€é¥¼å›¾ç­‰ |
| åŠ¨ç”» | lottie / rive | - | å® ç‰©åŠ¨ç”»æ•ˆæœ |

---

## 2. é¡¹ç›®ç›®å½•ç»“æ„

```
lib/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ app.dart                    # Appå…¥å£Widgetï¼ŒMaterialAppé…ç½®
â”‚   â”œâ”€â”€ router.dart                 # GoRouterè·¯ç”±é…ç½®
â”‚   â”œâ”€â”€ router.g.dart               # go_router_builderç”Ÿæˆçš„è·¯ç”±
â”‚   â””â”€â”€ providers.dart              # å…¨å±€Providerå®šä¹‰
â”‚
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ theme/
â”‚   â”‚   â”œâ”€â”€ app_colors.dart         # é¢œè‰²å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ app_text_styles.dart    # æ–‡å­—æ ·å¼
â”‚   â”‚   â””â”€â”€ app_theme.dart          # Light/Darkä¸»é¢˜é…ç½®
â”‚   â”œâ”€â”€ constants/
â”‚   â”‚   â”œâ”€â”€ route_names.dart        # è·¯ç”±åç§°å¸¸é‡
â”‚   â”‚   â”œâ”€â”€ db_constants.dart       # æ•°æ®åº“å¸¸é‡
â”‚   â”‚   â””â”€â”€ health_types.dart       # å¥åº·æ•°æ®ç±»å‹æšä¸¾
â”‚   â”œâ”€â”€ extensions/
â”‚   â”‚   â”œâ”€â”€ date_extension.dart     # DateTimeæ‰©å±•æ–¹æ³•
â”‚   â”‚   â”œâ”€â”€ string_extension.dart   # Stringæ‰©å±•æ–¹æ³•
â”‚   â”‚   â””â”€â”€ context_extension.dart  # BuildContextæ‰©å±•
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ date_utils.dart         # æ—¥æœŸå¤„ç†å·¥å…·
â”‚       â”œâ”€â”€ calorie_calculator.dart # çƒ­é‡è®¡ç®—(BMR/TDEE)
â”‚       â””â”€â”€ bmi_calculator.dart     # BMIè®¡ç®—
â”‚
â”œâ”€â”€ shared/
â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”œâ”€â”€ app_database.dart       # Driftæ•°æ®åº“ä¸»ç±»
â”‚   â”‚   â”œâ”€â”€ app_database.g.dart     # Driftç”Ÿæˆæ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ tables/
â”‚   â”‚   â”‚   â”œâ”€â”€ user_profiles.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ plans.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ weight_records.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ meal_logs.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ daily_metrics.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ goals.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ goal_logs.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ pet_states.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ weekly_summaries.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ health_sync_states.dart
â”‚   â”‚   â”‚   â””â”€â”€ app_settings.dart
â”‚   â”‚   â””â”€â”€ daos/
â”‚   â”‚       â”œâ”€â”€ user_profile_dao.dart
â”‚   â”‚       â”œâ”€â”€ plan_dao.dart
â”‚   â”‚       â”œâ”€â”€ weight_dao.dart
â”‚   â”‚       â”œâ”€â”€ meal_dao.dart
â”‚   â”‚       â”œâ”€â”€ metrics_dao.dart
â”‚   â”‚       â”œâ”€â”€ goal_dao.dart
â”‚   â”‚       â”œâ”€â”€ pet_dao.dart
â”‚   â”‚       â”œâ”€â”€ weekly_summary_dao.dart
â”‚   â”‚       â””â”€â”€ settings_dao.dart
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ notification_service.dart   # æœ¬åœ°é€šçŸ¥æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ health_sync_service.dart    # å¥åº·æ•°æ®åŒæ­¥æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ share_card_service.dart     # åˆ†äº«å¡ç‰‡ç”ŸæˆæœåŠ¡
â”‚   â”‚   â””â”€â”€ ai_chat_service.dart        # AIèŠå¤©æœåŠ¡
â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”œâ”€â”€ health_source_repository.dart   # å¥åº·æ•°æ®æºæ¥å£
â”‚   â”‚   â”œâ”€â”€ apple_health_repository.dart    # iOS HealthKitå®ç°
â”‚   â”‚   â””â”€â”€ health_connect_repository.dart  # Android Health Connectå®ç°
â”‚   â””â”€â”€ widgets/
â”‚       â”œâ”€â”€ app_scaffold.dart           # ç»Ÿä¸€é¡µé¢æ¡†æ¶
â”‚       â”œâ”€â”€ section_card.dart           # å¡ç‰‡ç»„ä»¶
â”‚       â”œâ”€â”€ loading_state.dart          # åŠ è½½çŠ¶æ€
â”‚       â”œâ”€â”€ empty_state.dart            # ç©ºçŠ¶æ€
â”‚       â”œâ”€â”€ error_state.dart            # é”™è¯¯çŠ¶æ€
â”‚       â””â”€â”€ bottom_nav_bar.dart         # åº•éƒ¨å¯¼èˆªæ 
â”‚
â”œâ”€â”€ features/
â”‚   â”œâ”€â”€ onboarding/                 # é¦–æ¬¡å¯åŠ¨å¼•å¯¼
â”‚   â”‚   â”œâ”€â”€ presentation/
â”‚   â”‚   â”‚   â”œâ”€â”€ onboarding_page.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ widgets/
â”‚   â”‚   â”‚   â””â”€â”€ onboarding_notifier.dart
â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â””â”€â”€ complete_onboarding_usecase.dart
â”‚   â”‚   â””â”€â”€ domain/
â”‚   â”‚       â””â”€â”€ onboarding_step.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ profile/                    # ä¸ªäººä¿¡æ¯
â”‚   â”‚   â”œâ”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â””â”€â”€ data/
â”‚   â”‚
â”‚   â”œâ”€â”€ health_source/              # å¥åº·æ•°æ®æºç®¡ç†
â”‚   â”‚   â”œâ”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â””â”€â”€ sync_health_data_usecase.dart
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ health_metric_type.dart
â”‚   â”‚   â”‚   â””â”€â”€ health_sample.dart
â”‚   â”‚   â””â”€â”€ data/
â”‚   â”‚
â”‚   â”œâ”€â”€ dashboard/                  # ä»Šå¤©Tab
â”‚   â”‚   â”œâ”€â”€ presentation/
â”‚   â”‚   â”‚   â”œâ”€â”€ dashboard_page.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ widgets/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ plan_overview_card.dart
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ calorie_card.dart
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ weight_card.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ weight_gauge.dart
â”‚   â”‚   â”‚   â””â”€â”€ dashboard_notifier.dart
â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ get_today_summary_usecase.dart
â”‚   â”‚   â”‚   â””â”€â”€ calculate_calorie_budget_usecase.dart
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â””â”€â”€ today_summary.dart
â”‚   â”‚   â””â”€â”€ data/
â”‚   â”‚
â”‚   â”œâ”€â”€ meals/                      # é¥®é£Ÿè®°å½•
â”‚   â”‚   â”œâ”€â”€ presentation/
â”‚   â”‚   â”‚   â”œâ”€â”€ add_meal_sheet.dart
â”‚   â”‚   â”‚   â””â”€â”€ meal_list_page.dart
â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â””â”€â”€ log_meal_usecase.dart
â”‚   â”‚   â””â”€â”€ domain/
â”‚   â”‚       â”œâ”€â”€ meal_type.dart
â”‚   â”‚       â””â”€â”€ food_template.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ weight/                     # ä½“é‡è®°å½•
â”‚   â”‚   â”œâ”€â”€ presentation/
â”‚   â”‚   â”‚   â”œâ”€â”€ weight_history_page.dart
â”‚   â”‚   â”‚   â””â”€â”€ add_weight_sheet.dart
â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â””â”€â”€ domain/
â”‚   â”‚
â”‚   â”œâ”€â”€ activity_calendar/          # è¡ŒåŠ¨Tabï¼ˆå¥èº«æ—¥å†ï¼‰
â”‚   â”‚   â”œâ”€â”€ presentation/
â”‚   â”‚   â”‚   â”œâ”€â”€ activity_calendar_page.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ widgets/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ week_view.dart
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ month_view.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ day_detail_page.dart
â”‚   â”‚   â”‚   â””â”€â”€ activity_calendar_notifier.dart
â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ get_week_stats_usecase.dart
â”‚   â”‚   â”‚   â””â”€â”€ get_month_heatmap_usecase.dart
â”‚   â”‚   â””â”€â”€ domain/
â”‚   â”‚       â”œâ”€â”€ week_stats.dart
â”‚   â”‚       â””â”€â”€ activity_level.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ goals/                      # ç›®æ ‡Tab
â”‚   â”‚   â”œâ”€â”€ presentation/
â”‚   â”‚   â”‚   â”œâ”€â”€ goals_page.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ widgets/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ goal_card.dart
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ create_goal_sheet.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ goal_edit_page.dart
â”‚   â”‚   â”‚   â””â”€â”€ goals_notifier.dart
â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ create_goal_usecase.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ toggle_goal_completion_usecase.dart
â”‚   â”‚   â”‚   â””â”€â”€ get_goal_templates_usecase.dart
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â”œâ”€â”€ goal.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ goal_period.dart
â”‚   â”‚   â”‚   â””â”€â”€ goal_template.dart
â”‚   â”‚   â””â”€â”€ data/
â”‚   â”‚
â”‚   â”œâ”€â”€ gamification/               # å® ç‰©å…»æˆ
â”‚   â”‚   â”œâ”€â”€ presentation/
â”‚   â”‚   â”‚   â”œâ”€â”€ pet_header.dart
â”‚   â”‚   â”‚   â””â”€â”€ pet_detail_page.dart
â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ gamification_service.dart
â”‚   â”‚   â”‚   â””â”€â”€ award_exp_usecase.dart
â”‚   â”‚   â””â”€â”€ domain/
â”‚   â”‚       â””â”€â”€ pet_state.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ review/                     # å›é¡¾åŠŸèƒ½
â”‚   â”‚   â”œâ”€â”€ presentation/
â”‚   â”‚   â”‚   â”œâ”€â”€ goal_review_page.dart
â”‚   â”‚   â”‚   â””â”€â”€ weekly_review_page.dart
â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â”œâ”€â”€ generate_weekly_summary_usecase.dart
â”‚   â”‚   â”‚   â””â”€â”€ generate_share_card_usecase.dart
â”‚   â”‚   â””â”€â”€ domain/
â”‚   â”‚       â”œâ”€â”€ weekly_summary.dart
â”‚   â”‚       â””â”€â”€ week_title.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ chat_ai/                    # AIèŠå¤©
â”‚   â”‚   â”œâ”€â”€ presentation/
â”‚   â”‚   â”‚   â”œâ”€â”€ chat_page.dart
â”‚   â”‚   â”‚   â”œâ”€â”€ widgets/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ message_bubble.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ quick_actions.dart
â”‚   â”‚   â”‚   â””â”€â”€ chat_notifier.dart
â”‚   â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”‚   â””â”€â”€ send_message_usecase.dart
â”‚   â”‚   â””â”€â”€ domain/
â”‚   â”‚       â”œâ”€â”€ chat_message.dart
â”‚   â”‚       â””â”€â”€ health_context.dart
â”‚   â”‚
â”‚   â””â”€â”€ settings/                   # è®¾ç½®Tab
â”‚       â”œâ”€â”€ presentation/
â”‚       â”‚   â”œâ”€â”€ settings_page.dart
â”‚       â”‚   â”œâ”€â”€ widgets/
â”‚       â”‚   â”‚   â”œâ”€â”€ activity_heatmap.dart
â”‚       â”‚   â”‚   â””â”€â”€ setting_tile.dart
â”‚       â”‚   â””â”€â”€ settings_notifier.dart
â”‚       â”œâ”€â”€ application/
â”‚       â””â”€â”€ domain/
â”‚
â””â”€â”€ main.dart                       # åº”ç”¨å…¥å£
```

---

## 3. åˆ†å±‚æ¶æ„è¯´æ˜

é‡‡ç”¨ **Clean Architecture** æ€æƒ³ï¼Œæ¯ä¸ª feature æ¨¡å—åŒ…å«å››å±‚ï¼š

### 3.1 Presentation å±‚
- **èŒè´£**ï¼šUIå±•ç¤ºã€ç”¨æˆ·äº¤äº’
- **ç»„ä»¶**ï¼š
  - `*_page.dart` - é¡µé¢Widget
  - `widgets/` - é¡µé¢ä¸“ç”¨ç»„ä»¶
  - `*_notifier.dart` - Riverpod StateNotifier/AsyncNotifier

### 3.2 Application å±‚
- **èŒè´£**ï¼šä¸šåŠ¡é€»è¾‘ç¼–æ’ã€ç”¨ä¾‹å°è£…
- **ç»„ä»¶**ï¼š
  - `*_usecase.dart` - å•ä¸€èŒè´£çš„ç”¨ä¾‹ç±»
  - `*_service.dart` - å¤æ‚ä¸šåŠ¡æœåŠ¡

### 3.3 Domain å±‚
- **èŒè´£**ï¼šæ ¸å¿ƒä¸šåŠ¡å®ä½“ã€Repositoryæ¥å£å®šä¹‰
- **ç»„ä»¶**ï¼š
  - å®ä½“ç±»ï¼ˆä½¿ç”¨ freezed ç”Ÿæˆä¸å¯å˜å¯¹è±¡ï¼‰
  - æšä¸¾å®šä¹‰
  - Repository æŠ½è±¡æ¥å£

### 3.4 Data å±‚
- **èŒè´£**ï¼šæ•°æ®æŒä¹…åŒ–ã€å¤–éƒ¨æ•°æ®æºå¯¹æ¥
- **ç»„ä»¶**ï¼š
  - Repository å®ç°ç±»
  - Drift DAO è°ƒç”¨
  - API æœåŠ¡è°ƒç”¨

---

## 4. æ•°æ®åº“ Schema è®¾è®¡ (Drift)

### 4.1 ç”¨æˆ·ç›¸å…³è¡¨

```dart
/// ç”¨æˆ·æ¡£æ¡ˆè¡¨
@DataClassName('UserProfile')
class UserProfiles extends Table {
  IntColumn get id => integer().autoIncrement()();
  TextColumn get gender => text().nullable()();           // male/female
  RealColumn get height => real().nullable()();           // èº«é«˜ (cm)
  RealColumn get weight => real().nullable()();           // å½“å‰ä½“é‡ (kg)
  DateTimeColumn get birthday => dateTime().nullable()(); // å‡ºç”Ÿæ—¥æœŸ
  TextColumn get activityLevel => text()                  // æ´»åŠ¨æ°´å¹³
      .withDefault(const Constant('sedentary'))();        // sedentary/light/moderate/active
  DateTimeColumn get createdAt => dateTime()
      .withDefault(currentDateAndTime)();
  DateTimeColumn get updatedAt => dateTime()
      .withDefault(currentDateAndTime)();
}

/// å‡é‡è®¡åˆ’è¡¨
@DataClassName('Plan')
class Plans extends Table {
  IntColumn get id => integer().autoIncrement()();
  RealColumn get initialWeight => real()();               // åˆå§‹ä½“é‡
  RealColumn get targetWeight => real()();                // ç›®æ ‡ä½“é‡
  IntColumn get durationDays => integer()();              // è®¡åˆ’å¤©æ•°
  IntColumn get dailyCalorieDeficit => integer()          // æ¯æ—¥çƒ­é‡ç¼ºå£
      .withDefault(const Constant(500))();
  DateTimeColumn get startDate => dateTime()();           // å¼€å§‹æ—¥æœŸ
  DateTimeColumn get endDate => dateTime()();             // ç»“æŸæ—¥æœŸ
  BoolColumn get isActive => boolean()                    // æ˜¯å¦æ¿€æ´»
      .withDefault(const Constant(true))();
  DateTimeColumn get createdAt => dateTime()
      .withDefault(currentDateAndTime)();
}
```

### 4.2 å¥åº·æ•°æ®è¡¨

```dart
/// ä½“é‡è®°å½•è¡¨
@DataClassName('WeightRecord')
class WeightRecords extends Table {
  IntColumn get id => integer().autoIncrement()();
  RealColumn get weight => real()();                      // ä½“é‡ (kg)
  DateTimeColumn get recordedAt => dateTime()();          // è®°å½•æ—¶é—´
  TextColumn get source => text()                         // æ•°æ®æ¥æº
      .withDefault(const Constant('manual'))();           // manual/apple_health/health_connect
      
  // ç´¢å¼•ä¼˜åŒ–
  @override
  List<Set<Column>> get uniqueKeys => [
    {recordedAt, source},  // åŒä¸€æ—¶é—´åŒä¸€æ¥æºä¸é‡å¤
  ];
}

/// é¥®é£Ÿè®°å½•è¡¨
@DataClassName('MealLog')
class MealLogs extends Table {
  IntColumn get id => integer().autoIncrement()();
  TextColumn get mealType => text()();                    // breakfast/lunch/dinner/snack
  TextColumn get foodName => text()();                    // é£Ÿç‰©åç§°
  IntColumn get calories => integer()();                  // çƒ­é‡ (kcal)
  DateTimeColumn get loggedAt => dateTime()();            // è®°å½•æ—¶é—´
  TextColumn get note => text().nullable()();             // å¤‡æ³¨
}

/// æ¯æ—¥æŒ‡æ ‡èšåˆè¡¨
@DataClassName('DailyMetric')
class DailyMetrics extends Table {
  IntColumn get id => integer().autoIncrement()();
  DateTimeColumn get date => dateTime()();                // æ—¥æœŸ (åªå­˜æ—¥æœŸéƒ¨åˆ†)
  IntColumn get steps => integer()                        // æ­¥æ•°
      .withDefault(const Constant(0))();
  IntColumn get activeMinutes => integer()                // æ´»åŠ¨åˆ†é’Ÿæ•°
      .withDefault(const Constant(0))();
  IntColumn get caloriesBurned => integer()               // æ¶ˆè€—çƒ­é‡ (kcal)
      .withDefault(const Constant(0))();
  RealColumn get sleepHours => real()                     // ç¡çœ æ—¶é•¿ (å°æ—¶)
      .withDefault(const Constant(0))();
  IntColumn get avgHeartRate => integer().nullable()();   // å¹³å‡å¿ƒç‡
  IntColumn get hrv => integer().nullable()();            // å¿ƒç‡å˜å¼‚æ€§
  DateTimeColumn get updatedAt => dateTime()
      .withDefault(currentDateAndTime)();
      
  // æ¯å¤©åªæœ‰ä¸€æ¡è®°å½•
  @override
  List<Set<Column>> get uniqueKeys => [{date}];
}

/// å¥åº·æ•°æ®åŒæ­¥çŠ¶æ€è¡¨
@DataClassName('HealthSyncState')
class HealthSyncStates extends Table {
  IntColumn get id => integer().autoIncrement()();
  TextColumn get metricType => text()();                  // steps/sleep/weight/heartRate/hrv
  DateTimeColumn get lastSyncedAt => dateTime()();        // æœ€ååŒæ­¥æ—¶é—´
  
  @override
  List<Set<Column>> get uniqueKeys => [{metricType}];
}
```

### 4.3 ç›®æ ‡ç›¸å…³è¡¨

```dart
/// ç›®æ ‡å®šä¹‰è¡¨
@DataClassName('Goal')
class Goals extends Table {
  IntColumn get id => integer().autoIncrement()();
  TextColumn get name => text()();                        // ç›®æ ‡åç§°
  TextColumn get icon => text()                           // å›¾æ ‡ (emojiæˆ–icon name)
      .withDefault(const Constant('ğŸ¯'))();
  TextColumn get period => text()();                      // daily/weekly
  IntColumn get target => integer()();                    // ç›®æ ‡å€¼ (æ¬¡æ•°æˆ–å¤©æ•°)
  TextColumn get reminderTime => text().nullable()();     // æé†’æ—¶é—´ HH:mm
  BoolColumn get enabled => boolean()                     // æ˜¯å¦å¯ç”¨
      .withDefault(const Constant(true))();
  IntColumn get sortOrder => integer()                    // æ’åºé¡ºåº
      .withDefault(const Constant(0))();
  DateTimeColumn get createdAt => dateTime()
      .withDefault(currentDateAndTime)();
}

/// ç›®æ ‡å®Œæˆè®°å½•è¡¨
@DataClassName('GoalLog')
class GoalLogs extends Table {
  IntColumn get id => integer().autoIncrement()();
  IntColumn get goalId => integer()                       // å…³è”ç›®æ ‡ID
      .references(Goals, #id, onDelete: KeyAction.cascade)();
  DateTimeColumn get date => dateTime()();                // æ—¥æœŸ
  IntColumn get progress => integer()                     // å®Œæˆè¿›åº¦
      .withDefault(const Constant(0))();
  DateTimeColumn get updatedAt => dateTime()
      .withDefault(currentDateAndTime)();
      
  // æ¯ä¸ªç›®æ ‡æ¯å¤©åªæœ‰ä¸€æ¡è®°å½•
  @override
  List<Set<Column>> get uniqueKeys => [{goalId, date}];
}
```

### 4.4 æ¸¸æˆåŒ–ç›¸å…³è¡¨

```dart
/// å® ç‰©çŠ¶æ€è¡¨
@DataClassName('PetState')
class PetStates extends Table {
  IntColumn get id => integer().autoIncrement()();
  TextColumn get name => text()                           // å® ç‰©åå­—
      .withDefault(const Constant('TATA'))();
  IntColumn get level => integer()                        // ç­‰çº§
      .withDefault(const Constant(1))();
  IntColumn get exp => integer()                          // å½“å‰ç»éªŒå€¼
      .withDefault(const Constant(0))();
  IntColumn get companionDays => integer()                // é™ªä¼´å¤©æ•°
      .withDefault(const Constant(0))();
  TextColumn get currentSkin => text()                    // å½“å‰çš®è‚¤
      .withDefault(const Constant('default'))();
  DateTimeColumn get lastActiveDate => dateTime()         // æœ€åæ´»è·ƒæ—¥æœŸ
      .nullable()();
  DateTimeColumn get createdAt => dateTime()
      .withDefault(currentDateAndTime)();
}

/// æ¯å‘¨å›é¡¾ç¼“å­˜è¡¨
@DataClassName('WeeklySummary')
class WeeklySummaries extends Table {
  IntColumn get id => integer().autoIncrement()();
  DateTimeColumn get weekStart => dateTime()();           // å‘¨èµ·å§‹æ—¥æœŸ
  RealColumn get avgSleepHours => real()();               // å¹³å‡ç¡çœ 
  IntColumn get avgHrv => integer().nullable()();         // å¹³å‡HRV
  IntColumn get totalSteps => integer()();                // æ€»æ­¥æ•°
  IntColumn get totalCaloriesBurned => integer()();       // æ€»æ¶ˆè€—
  IntColumn get exerciseMinutes => integer()();           // è¿åŠ¨æ€»æ—¶é•¿
  IntColumn get waterDays => integer()();                 // é¥®æ°´å¤©æ•°
  IntColumn get goalCompletionRate => integer()();        // ç›®æ ‡å®Œæˆç‡ (0-100)
  TextColumn get title => text()();                       // å‘¨ç§°å·
  DateTimeColumn get generatedAt => dateTime()
      .withDefault(currentDateAndTime)();
      
  @override
  List<Set<Column>> get uniqueKeys => [{weekStart}];
}
```

### 4.5 è®¾ç½®è¡¨

```dart
/// åº”ç”¨è®¾ç½®è¡¨
@DataClassName('AppSetting')
class AppSettings extends Table {
  IntColumn get id => integer().autoIncrement()();
  TextColumn get key => text()();                         // è®¾ç½®é”®
  TextColumn get value => text()();                       // è®¾ç½®å€¼
  
  @override
  List<Set<Column>> get uniqueKeys => [{key}];
}

// é¢„å®šä¹‰çš„è®¾ç½®é”®
// - 'weight_unit': 'kg' | 'lb'
// - 'height_unit': 'cm' | 'inch'
// - 'language': 'zh' | 'en'
// - 'theme_mode': 'light' | 'dark' | 'system'
// - 'notifications_enabled': 'true' | 'false'
// - 'onboarding_completed': 'true' | 'false'
// - 'health_source': 'apple_health' | 'health_connect' | 'none'
```

---

## 5. æ ¸å¿ƒæ¥å£è®¾è®¡

### 5.1 å¥åº·æ•°æ®æºæ¥å£

```dart
/// å¥åº·æŒ‡æ ‡ç±»å‹
enum HealthMetricType {
  steps,
  activeMinutes,
  caloriesBurned,
  sleepHours,
  heartRate,
  hrv,
  weight,
}

/// å¥åº·æ•°æ®æ ·æœ¬
class HealthSample {
  final HealthMetricType type;
  final num value;
  final DateTime startTime;
  final DateTime endTime;
  final String source;
  
  const HealthSample({
    required this.type,
    required this.value,
    required this.startTime,
    required this.endTime,
    required this.source,
  });
}

/// å¥åº·æ•°æ®æºä»“åº“æ¥å£
abstract class HealthSourceRepository {
  /// æ£€æŸ¥å¥åº·æ•°æ®æºæ˜¯å¦å¯ç”¨
  Future<bool> isAvailable();
  
  /// è¯·æ±‚æ•°æ®è®¿é—®æƒé™ï¼ˆè‡ªåŠ¨è¯·æ±‚æ‰€æœ‰æ”¯æŒçš„æ•°æ®ç±»å‹ï¼‰
  Future<bool> requestPermissions();
  
  /// æ£€æŸ¥æƒé™çŠ¶æ€ï¼ˆæ£€æŸ¥æ‰€æœ‰æ”¯æŒçš„æ•°æ®ç±»å‹ï¼‰
  Future<Map<HealthMetricType, bool>> checkPermissions();
  
  /// è·å–æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„æ•°æ®æ ·æœ¬
  Future<List<HealthSample>> fetchSamples({
    required HealthMetricType type,
    required DateTime from,
    required DateTime to,
  });
  
  /// è·å–æŒ‡å®šæ—¥æœŸçš„æ­¥æ•°æ€»è®¡
  Future<int> getTotalSteps(DateTime date);
  
  /// è·å–æŒ‡å®šæ—¥æœŸçš„å…¨éƒ¨å¥åº·æ•°æ®
  Future<DailyHealthData> getDailyData(DateTime date);
  
  /// è·å–æœ€è¿‘30å¤©çš„æœ€æ–°ä½“é‡è®°å½•
  Future<double?> getLatestWeight();
}
```

### 5.2 é€šçŸ¥æœåŠ¡æ¥å£

```dart
/// é€šçŸ¥æœåŠ¡
abstract class NotificationService {
  /// åˆå§‹åŒ–é€šçŸ¥æœåŠ¡
  Future<void> initialize();
  
  /// è¯·æ±‚é€šçŸ¥æƒé™
  Future<bool> requestPermission();
  
  /// è°ƒåº¦ç›®æ ‡æé†’
  Future<void> scheduleGoalReminder({
    required int goalId,
    required String goalName,
    required TimeOfDay time,
  });
  
  /// å–æ¶ˆç›®æ ‡æé†’
  Future<void> cancelGoalReminder(int goalId);
  
  /// å–æ¶ˆæ‰€æœ‰æé†’
  Future<void> cancelAllReminders();
  
  /// æ˜¾ç¤ºå³æ—¶é€šçŸ¥
  Future<void> showNotification({
    required String title,
    required String body,
    String? payload,
  });
}
```

### 5.3 AIèŠå¤©æœåŠ¡æ¥å£

```dart
/// å¥åº·ä¸Šä¸‹æ–‡ï¼ˆç”¨äºAIå¯¹è¯ï¼‰
class HealthContext {
  final int todaySteps;
  final int todayCaloriesBurned;
  final int todayCaloriesIntake;
  final double sleepHours;
  final List<GoalProgress> goals;
  final double? currentWeight;
  final double? targetWeight;
  
  const HealthContext({
    required this.todaySteps,
    required this.todayCaloriesBurned,
    required this.todayCaloriesIntake,
    required this.sleepHours,
    required this.goals,
    this.currentWeight,
    this.targetWeight,
  });
  
  Map<String, dynamic> toPromptData() => {
    'steps': todaySteps,
    'caloriesBurned': todayCaloriesBurned,
    'caloriesIntake': todayCaloriesIntake,
    'sleepHours': sleepHours,
    'goalsCompleted': goals.where((g) => g.isCompleted).length,
    'goalsTotal': goals.length,
  };
}

/// AIèŠå¤©æœåŠ¡
abstract class AiChatService {
  /// å‘é€æ¶ˆæ¯å¹¶è·å–å›å¤
  Future<String> sendMessage({
    required String message,
    required HealthContext context,
    List<ChatMessage>? history,
  });
  
  /// æµå¼å‘é€æ¶ˆæ¯
  Stream<String> streamMessage({
    required String message,
    required HealthContext context,
    List<ChatMessage>? history,
  });
}
```

---

## 6. è·¯ç”±é…ç½®

```dart
// app/router.dart
import 'package:go_router/go_router.dart';

final appRouter = GoRouter(
  initialLocation: '/',
  routes: [
    // Onboarding
    GoRoute(
      path: '/onboarding',
      name: 'onboarding',
      builder: (context, state) => const OnboardingPage(),
    ),
    
    // Main Shell (åº•éƒ¨å¯¼èˆª)
    ShellRoute(
      builder: (context, state, child) => MainShell(child: child),
      routes: [
        // Tab 1: ä»Šå¤©
        GoRoute(
          path: '/',
          name: 'dashboard',
          builder: (context, state) => const DashboardPage(),
          routes: [
            GoRoute(
              path: 'plan/create',
              name: 'createPlan',
              builder: (context, state) => const CreatePlanPage(),
            ),
            GoRoute(
              path: 'weight/history',
              name: 'weightHistory',
              builder: (context, state) => const WeightHistoryPage(),
            ),
            GoRoute(
              path: 'meals/:mealType',
              name: 'addMeal',
              builder: (context, state) => AddMealPage(
                mealType: state.pathParameters['mealType']!,
              ),
            ),
          ],
        ),
        
        // Tab 2: è¡ŒåŠ¨
        GoRoute(
          path: '/activity',
          name: 'activity',
          builder: (context, state) => const ActivityCalendarPage(),
          routes: [
            GoRoute(
              path: 'day/:date',
              name: 'dayDetail',
              builder: (context, state) => DayDetailPage(
                date: DateTime.parse(state.pathParameters['date']!),
              ),
            ),
          ],
        ),
        
        // Tab 3: ç›®æ ‡
        GoRoute(
          path: '/goals',
          name: 'goals',
          builder: (context, state) => const GoalsPage(),
          routes: [
            GoRoute(
              path: 'create',
              name: 'createGoal',
              builder: (context, state) => const CreateGoalPage(),
            ),
            GoRoute(
              path: ':id/edit',
              name: 'editGoal',
              builder: (context, state) => EditGoalPage(
                goalId: int.parse(state.pathParameters['id']!),
              ),
            ),
            GoRoute(
              path: 'review',
              name: 'goalReview',
              builder: (context, state) => const GoalReviewPage(),
            ),
          ],
        ),
        
        // Tab 4: è®¾ç½®
        GoRoute(
          path: '/settings',
          name: 'settings',
          builder: (context, state) => const SettingsPage(),
          routes: [
            GoRoute(
              path: 'profile',
              name: 'profile',
              builder: (context, state) => const ProfilePage(),
            ),
            GoRoute(
              path: 'health-source',
              name: 'healthSource',
              builder: (context, state) => const HealthSourcePage(),
            ),
          ],
        ),
      ],
    ),
    
    // ç‹¬ç«‹é¡µé¢
    GoRoute(
      path: '/pet',
      name: 'petDetail',
      builder: (context, state) => const PetDetailPage(),
    ),
    GoRoute(
      path: '/weekly-review',
      name: 'weeklyReview',
      builder: (context, state) => const WeeklyReviewPage(),
    ),
    GoRoute(
      path: '/chat',
      name: 'chat',
      builder: (context, state) => const ChatPage(),
    ),
  ],
  
  // é‡å®šå‘é€»è¾‘
  redirect: (context, state) {
    final onboardingCompleted = /* ä»è®¾ç½®è¯»å– */;
    if (!onboardingCompleted && state.matchedLocation != '/onboarding') {
      return '/onboarding';
    }
    return null;
  },
);
```

---

## 7. çŠ¶æ€ç®¡ç† (Riverpod)

### 7.1 å…¨å±€Provider

```dart
// app/providers.dart

/// æ•°æ®åº“å®ä¾‹
@Riverpod(keepAlive: true)
AppDatabase database(Ref ref) => AppDatabase();

/// é€šçŸ¥æœåŠ¡
@Riverpod(keepAlive: true)
NotificationService notificationService(Ref ref) => NotificationServiceImpl();

/// å¥åº·æ•°æ®æº
@Riverpod(keepAlive: true)
HealthSourceRepository healthSource(Ref ref) {
  if (Platform.isIOS) {
    return AppleHealthRepository();
  } else {
    return HealthConnectRepository();
  }
}

/// å½“å‰ç”¨æˆ·æ¡£æ¡ˆ
@riverpod
Future<UserProfile?> currentProfile(Ref ref) {
  final db = ref.watch(databaseProvider);
  return db.userProfileDao.getProfile();
}

/// å½“å‰æ¿€æ´»è®¡åˆ’
@riverpod
Future<Plan?> activePlan(Ref ref) {
  final db = ref.watch(databaseProvider);
  return db.planDao.getActivePlan();
}

/// å® ç‰©çŠ¶æ€
@riverpod
Future<PetState> petState(Ref ref) async {
  final db = ref.watch(databaseProvider);
  return await db.petDao.getOrCreateState();
}
```

### 7.2 Feature Provider ç¤ºä¾‹

```dart
// features/dashboard/presentation/dashboard_notifier.dart

@riverpod
class DashboardNotifier extends _$DashboardNotifier {
  @override
  Future<DashboardState> build() async {
    final db = ref.watch(databaseProvider);
    final today = DateTime.now().dateOnly;
    
    final [metrics, meals, plan, latestWeight] = await Future.wait([
      db.metricsDao.getMetrics(today),
      db.mealDao.getMeals(today),
      db.planDao.getActivePlan(),
      db.weightDao.getLatestWeight(),
    ]);
    
    return DashboardState(
      todayMetrics: metrics,
      todayMeals: meals,
      activePlan: plan,
      latestWeight: latestWeight,
    );
  }
  
  Future<void> logWeight(double weight) async {
    final db = ref.read(databaseProvider);
    await db.weightDao.insertWeight(weight);
    ref.invalidateSelf();
  }
  
  Future<void> syncHealthData() async {
    final useCase = ref.read(syncHealthDataUseCaseProvider);
    await useCase.call();
    ref.invalidateSelf();
  }
}
```

---

## 8. å…³é”®è®¡ç®—å…¬å¼

### 8.1 BMR (åŸºç¡€ä»£è°¢ç‡)

```dart
/// Harris-Benedict å…¬å¼
double calculateBMR({
  required String gender,
  required double weightKg,
  required double heightCm,
  required int age,
}) {
  if (gender == 'male') {
    return 88.362 + (13.397 * weightKg) + (4.799 * heightCm) - (5.677 * age);
  } else {
    return 447.593 + (9.247 * weightKg) + (3.098 * heightCm) - (4.330 * age);
  }
}
```

### 8.2 TDEE (æ¯æ—¥æ€»æ¶ˆè€—)

```dart
/// æ´»åŠ¨ç³»æ•°
const activityMultipliers = {
  'sedentary': 1.2,      // ä¹…å
  'light': 1.375,        // è½»åº¦æ´»åŠ¨
  'moderate': 1.55,      // ä¸­åº¦æ´»åŠ¨
  'active': 1.725,       // é«˜åº¦æ´»åŠ¨
};

double calculateTDEE(double bmr, String activityLevel) {
  return bmr * (activityMultipliers[activityLevel] ?? 1.2);
}
```

### 8.3 BMI

```dart
double calculateBMI(double weightKg, double heightCm) {
  final heightM = heightCm / 100;
  return weightKg / (heightM * heightM);
}

String getBMICategory(double bmi) {
  if (bmi < 18.5) return 'åç˜¦';
  if (bmi < 24) return 'æ­£å¸¸';
  if (bmi < 28) return 'åèƒ–';
  return 'è‚¥èƒ–';
}
```

### 8.4 çƒ­é‡é¢„ç®—

```dart
int calculateRemainingCalories({
  required int caloriesBurned,
  required int caloriesIntake,
  required int deficitTarget,
}) {
  final remaining = caloriesBurned - caloriesIntake - deficitTarget;
  return remaining.clamp(0, double.infinity).toInt();
}
```

### 8.5 å® ç‰©ç»éªŒ

```dart
/// å‡çº§æ‰€éœ€ç»éªŒï¼ˆçº¿æ€§å¢é•¿ï¼‰
int expNeeded(int level) => level * 100;

/// å¥–åŠ±ç»éªŒå¹¶å¤„ç†å‡çº§
(int newLevel, int newExp) awardExp(int currentLevel, int currentExp, int expGain) {
  var exp = currentExp + expGain;
  var level = currentLevel;
  
  while (exp >= expNeeded(level)) {
    exp -= expNeeded(level);
    level++;
  }
  
  return (level, exp);
}
```

---

## 9. å¹³å°é…ç½®è¦ç‚¹

### 9.1 iOS (HealthKit)

**ios/Runner/Info.plist**:
```xml
<key>NSHealthShareUsageDescription</key>
<string>æˆ‘ä»¬éœ€è¦è¯»å–æ‚¨çš„å¥åº·æ•°æ®ä»¥æä¾›ä¸ªæ€§åŒ–çš„å¥åº·å»ºè®®å’Œè¿½è¸ªæ‚¨çš„è¿åŠ¨è¿›åº¦ã€‚</string>
<key>NSHealthUpdateUsageDescription</key>
<string>æˆ‘ä»¬å¯èƒ½ä¼šå°†æ‚¨è®°å½•çš„ä½“é‡æ•°æ®åŒæ­¥åˆ°å¥åº·åº”ç”¨ã€‚</string>
<key>UIBackgroundModes</key>
<array>
    <string>fetch</string>
</array>
```

**Xcode**: åœ¨ Signing & Capabilities ä¸­æ·»åŠ  HealthKit capabilityã€‚

### 9.2 Android (Health Connect)

**android/app/src/main/AndroidManifest.xml**:
```xml
<!-- Health Connect æƒé™ -->
<uses-permission android:name="android.permission.health.READ_STEPS"/>
<uses-permission android:name="android.permission.health.READ_HEART_RATE"/>
<uses-permission android:name="android.permission.health.READ_SLEEP"/>
<uses-permission android:name="android.permission.health.READ_WEIGHT"/>
<uses-permission android:name="android.permission.health.READ_ACTIVE_CALORIES_BURNED"/>
<uses-permission android:name="android.permission.health.WRITE_WEIGHT"/>

<!-- é€šçŸ¥æƒé™ -->
<uses-permission android:name="android.permission.POST_NOTIFICATIONS"/>
<uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM"/>
<uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED"/>

<application>
    <!-- Health Connect Intent Filter -->
    <intent-filter>
        <action android:name="androidx.health.ACTION_SHOW_PERMISSIONS_RATIONALE"/>
    </intent-filter>
    
    <!-- é€šçŸ¥ç›¸å…³ -->
    <receiver android:name="com.dexterous.flutterlocalnotifications.ScheduledNotificationReceiver" />
    <receiver android:name="com.dexterous.flutterlocalnotifications.ScheduledNotificationBootReceiver">
        <intent-filter>
            <action android:name="android.intent.action.BOOT_COMPLETED"/>
        </intent-filter>
    </receiver>
</application>
```
